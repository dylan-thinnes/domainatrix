!function(t){function e(r){if(n[r])return n[r].exports;var a=n[r]={i:r,l:!1,exports:{}};return t[r].call(a.exports,a,a.exports,e),a.l=!0,a.exports}var n={};e.m=t,e.c=n,e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=6)}([function(t,e){t.exports=require("path")},function(t,e){t.exports=require("express")},function(t,e,n){"use strict";function r(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,n){function r(a,i){try{var s=e[a](i),o=s.value}catch(t){return void n(t)}if(!s.done)return Promise.resolve(o).then(function(t){r("next",t)},function(t){r("throw",t)});t(o)}return r("next")})}}var a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i=(n(9),n(10)),s=n(13),o=s("better-sqlite3"),u=n(4),p=n(3),c=n(5),d=n(0),h=function(){this.domains={},this.orderedDomains=[],this.db=new o(d.resolve("./app.db")),this.db.sRun("CREATE TABLE IF NOT EXISTS domains (\n        name TEXT PRIMARY KEY,\n        dns STRING,\n        dnsState INTEGER NOT NULL DEFAULT -2,\n        dnsLastUpdate INTEGER NOT NULL DEFAULT 0,\n        ping STRING,\n        pingState INTEGER NOT NULL DEFAULT -2,\n        pingLastUpdate INTEGER NOT NULL DEFAULT 0,\n        http STRING,\n        httpState INTEGER NOT NULL DEFAULT -2,\n        httpLastUpdate INTEGER NOT NULL DEFAULT 0,\n        children STRING,\n        childrenState INTEGER NOT NULL DEFAULT -2,\n        childrenLastUpdate INTEGER NOT NULL DEFAULT 0\n    )")};t.exports=h,h.prototype.init=r(regeneratorRuntime.mark(function t(){var e,n,r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:for(e=this.db.sAll("SELECT * FROM domains ORDER BY name ASC"),n=[],r=0;r<e.length;r++)n[this.addDomainCandidate(e[r].name,e[r])];return t.next=5,Promise.all(n);case 5:return t.abrupt("return");case 6:case"end":return t.stop()}},t,this)})),h.prototype.edAcUkSearch=new RegExp(/(?![^A-Za-z0-9\-])([A-Za-z0-9\-\.]+\.|)ed\.ac\.uk(?=[^A-Za-z0-9\-])/g),h.prototype.ipV4AddrSearch=new RegExp(/((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])/g),h.prototype.ipV6AddrSearch=new RegExp(/(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))/g),h.prototype.extractDomains=function(){var t=r(regeneratorRuntime.mark(function t(e){var n,r,a,i,s,o,u;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e=" "+e+" ",n=e.match(this.edAcUkSearch);for(r in n)n[r]=n[r].toLowerCase();void 0==n&&(n=[]),a=e.match(this.ipV4AddrSearch),void 0==a&&(a=[]),i=e.match(this.ipV6AddrSearch),void 0==i&&(i=[]),s=a.concat(i),o=c.promisify(p.reverse),t.t0=regeneratorRuntime.keys(s);case 11:if((t.t1=t.t0()).done){t.next=25;break}return r=t.t1.value,t.prev=13,t.next=16,o(s[r]);case 16:u=t.sent,t.next=22;break;case 19:return t.prev=19,t.t2=t.catch(13),t.abrupt("continue",11);case 22:n=n.concat(u),t.next=11;break;case 25:return t.abrupt("return",n);case 26:case"end":return t.stop()}},t,this,[[13,19]])}));return function(e){return t.apply(this,arguments)}}(),h.prototype.updateXFromDomain=function(t,e){return this.getXFromDomain(t,e,!0)},h.prototype.getXFromDomain=function(){var t=r(regeneratorRuntime.mark(function t(e,n,r){var a,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!=(a=this.domains[n])){t.next=3;break}return t.abrupt("return",{state:2});case 3:if(!0!==r){t.next=6;break}return t.next=6,a[e].update();case 6:return i={},i[e]={},i[e].value=a[e].value,i[e].state=a[e].state,i[e].lastUpdate=a[e].lastUpdate,t.abrupt("return",i);case 12:case"end":return t.stop()}},t,this)}));return function(e,n,r){return t.apply(this,arguments)}}(),h.prototype.findOrderedIndex=function(t,e,n){for(e=void 0!=e?e:0,n=void 0!=n?n:this.orderedDomains.length;e!==n;){this.orderedDomains[e+Math.floor((n-e)/2)]>t?n=e+Math.floor((n-e)/2):e=n-Math.floor((n-e)/2)}return e},h.prototype.addDomainCandidates=function(){var t=r(regeneratorRuntime.mark(function t(e){var n,r,a;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.extractDomains(e);case 2:n=t.sent,r=[];for(a in n)r.push(this.addDomainCandidate(n[a]));return t.next=7,Promise.all(r);case 7:return t.abrupt("return",t.sent);case 8:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),h.prototype.addDomainCandidate=function(){var t=r(regeneratorRuntime.mark(function t(e,n){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0==this.domains[e]){t.next=2;break}return t.abrupt("return",{name:e,state:1});case 2:if(this.domains[e]={},r=new i(e,this.db,this.addDomainCandidates.bind(this)),void 0==n||"object"!==(void 0===n?"undefined":a(n))){t.next=8;break}r.setFromDb(n),t.next=19;break;case 8:return t.next=10,r.create();case 10:return t.next=12,r.dns.update();case 12:if(r.dns.state!==u.DOES_NOT_EXIST){t.next=16;break}return r.delete(),delete this.domains[e],t.abrupt("return",{name:e,state:2});case 16:r.ping.update(),r.http.update(),r.children.update();case 19:return this.domains[e]=r,this.orderedDomains.splice(this.findOrderedIndex(e),0,e),t.abrupt("return",{name:e,state:0,data:r.toJson()});case 22:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}(),h.prototype.getJson=function(t){if(void 0!=t){if(void 0==this.domains[t])return;return this.domains[t].toJson()}for(var e=[],n=0;n<this.orderedDomains.length;n++){var r=this.orderedDomains[n];!1!==this.domains[r].initDone&&e.push(this.domains[r].toJson())}return e}},function(t,e){t.exports=require("dns")},function(t,e,n){"use strict";function r(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,n){function r(a,i){try{var s=e[a](i),o=s.value}catch(t){return void n(t)}if(!s.done)return Promise.resolve(o).then(function(t){r("next",t)},function(t){r("throw",t)});t(o)}return r("next")})}}var a=n(5),i=function t(e,n){this.onChangeCallback=e,this.remoteGetter=n,this.state=t.NEVER_STARTED,this.value=void 0,this.lastUpdate=0,this.waiters=[]};t.exports=i,i.NEVER_STARTED=-2,i.IN_PROGRESS=-1,i.DOES_EXIST=0,i.DOES_NOT_EXIST=1,i.UPDATE_THRESHOLD=process.argv.includes("-d")?0:3600,i.prototype.valueOf=function(){return this.state},i.prototype.set=function(){var t=r(regeneratorRuntime.mark(function t(e,n){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.state=void 0!=e?i.DOES_EXIST:i.DOES_NOT_EXIST,!a.isDeepStrictEqual(this.value,e)){t.next=3;break}return t.abrupt("return");case 3:if(this.value=e,!0===n){t.next=7;break}return t.next=7,this.onChangeCallback();case 7:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}(),i.prototype.get=function(){return this.value},i.prototype.update=r(regeneratorRuntime.mark(function t(){var e,n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(this.state!==i.IN_PROGRESS){t.next=4;break}return t.next=3,this.waitForUpdate();case 3:return t.abrupt("return",!0);case 4:if(e=Date.now(),!(Date.now()<this.lastUpdate+i.UPDATE_THRESHOLD)){t.next=7;break}return t.abrupt("return",!1);case 7:return this.lastUpdate=e,this.state=i.IN_PROGRESS,t.next=11,new Promise(this.remoteGetter);case 11:return n=t.sent,void 0==n||0===n.length?n=void 0:(this.additionalData=n[1],n=n[0]),t.next=15,this.set(n);case 15:for(;0!==this.waiters.length;)this.waiters.pop()();return t.abrupt("return",!0);case 17:case"end":return t.stop()}},t,this)})),i.prototype.waitForUpdate=function(){if(this.state===i.IN_PROGRESS)return new Promise(function(t,e){this.waiters.push(t)}.bind(this))}},function(t,e){t.exports=require("util")},function(t,e,n){"use strict";n(7);var r=n(0),a=n(1),i=a(),s=n(8),o=n(14),u=n(15);i.use(u()),console.log(r.join(__dirname,"../client")),i.use(a.static(r.join(__dirname,"../client"))),i.use(o.urlencoded({extended:!1})),s.makeRoutes().then(function(t){i.use(t),i.get("*",function(t,e){e.status=404,e.send("")})}),process.argv.includes("-d")&&i.listen(8080),t.exports=i},function(t,e){t.exports=require("babel-polyfill")},function(t,e,n){"use strict";function r(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,n){function r(a,i){try{var s=e[a](i),o=s.value}catch(t){return void n(t)}if(!s.done)return Promise.resolve(o).then(function(t){r("next",t)},function(t){r("throw",t)});t(o)}return r("next")})}}var a=n(1),i=n(2),s=function(){var t=r(regeneratorRuntime.mark(function t(){var e,n,s=this;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return e=a(),n=new i,t.next=4,n.init();case 4:return e.put("/v1/domains/:name/dns",function(){var t=r(regeneratorRuntime.mark(function t(e,r,a){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!=e.params.name){t.next=2;break}return t.abrupt("return",a());case 2:return t.next=4,n.updateXFromDomain("dns",e.params.name);case 4:i=t.sent,r.json(i);case 6:case"end":return t.stop()}},t,s)}));return function(e,n,r){return t.apply(this,arguments)}}()),e.put("/v1/domains/:name/ping",function(){var t=r(regeneratorRuntime.mark(function t(e,r,a){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!=e.params.name){t.next=2;break}return t.abrupt("return",a());case 2:return t.next=4,n.updateXFromDomain("ping",e.params.name);case 4:i=t.sent,r.json(i);case 6:case"end":return t.stop()}},t,s)}));return function(e,n,r){return t.apply(this,arguments)}}()),e.put("/v1/domains/:name/http",function(){var t=r(regeneratorRuntime.mark(function t(e,r,a){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!=e.params.name){t.next=2;break}return t.abrupt("return",a());case 2:return t.next=4,n.updateXFromDomain("http",e.params.name);case 4:i=t.sent,r.json(i);case 6:case"end":return t.stop()}},t,s)}));return function(e,n,r){return t.apply(this,arguments)}}()),e.put("/v1/domains/:name/children",function(){var t=r(regeneratorRuntime.mark(function t(e,r,a){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!=e.params.name){t.next=2;break}return t.abrupt("return",a());case 2:return t.next=4,n.updateXFromDomain("children",e.params.name);case 4:i=t.sent,r.json(i);case 6:case"end":return t.stop()}},t,s)}));return function(e,n,r){return t.apply(this,arguments)}}()),e.get("/v1/domains/:name",function(){var t=r(regeneratorRuntime.mark(function t(e,r,a){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!=e.params.name){t.next=2;break}return t.abrupt("return",a());case 2:i=n.getJson(e.params.name),void 0==i?a():r.json(i);case 4:case"end":return t.stop()}},t,s)}));return function(e,n,r){return t.apply(this,arguments)}}()),e.post("/v1/domains",function(){var t=r(regeneratorRuntime.mark(function t(e,r,a){var i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!=e.body.names){t.next=2;break}return t.abrupt("return",a());case 2:return t.next=4,n.addDomainCandidates(e.body.names);case 4:i=t.sent,r.json(i);case 6:case"end":return t.stop()}},t,s)}));return function(e,n,r){return t.apply(this,arguments)}}()),e.get("/v1/domains",function(t,e){e.json(n.getJson())}),t.abrupt("return",e);case 12:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}();t.exports={makeRoutes:s}},function(t,e){t.exports=require("url")},function(t,e,n){"use strict";function r(t){return function(){var e=t.apply(this,arguments);return new Promise(function(t,n){function r(a,i){try{var s=e[a](i),o=s.value}catch(t){return void n(t)}if(!s.done)return Promise.resolve(o).then(function(t){r("next",t)},function(t){r("throw",t)});t(o)}return r("next")})}}var a=n(3),i=n(11),s=n(12),o=n(4),u=(n(2),function(t,e,n){this.name=t,this.db=e,this.dns=new o(this.writeState.bind(this,"dns"),this.getRemoteDns.bind(this)),this.ping=new o(this.writeState.bind(this,"ping"),this.getRemotePing.bind(this)),this.http=new o(this.writeState.bind(this,"http"),this.getRemoteHttp.bind(this)),this.children=new o(this.writeState.bind(this,"children"),this.getRemoteChildren.bind(this)),this.addDomainCandidates=n,this.childCandidates=[]});t.exports=u,u.prototype.getRemoteChildren=function(){var t=r(regeneratorRuntime.mark(function t(e,n){var r,a,i,s,o,u,p,c;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=" ",t.next=3,Promise.all([this.dns.waitForUpdate(),void 0==this.http.additionalData?this.http.update():this.http.waitForUpdate()]);case 3:for(a in this.dns.value){i=this.dns.value[a];for(s in i)"A"===a||"AAAA"===a||"CNAME"===a||"PTR"===a||"NS"===a?r+=i[s]+" ":"TXT"===a?r+=i[s].join(" ")+" ":"SRV"===a?r+=i[s].name+" ":"SOA"===a?(r+=i[s].nsname+" ",r+=i[s].hostmaster+" "):"NAPTR"===a?r+=i[s].replacement+" ":"MX"===a&&(r+=i[s].exchange+" ")}return void 0!=this.http.additionalData&&(r+=this.http.additionalData+" "),t.next=7,this.addDomainCandidates(r);case 7:o=t.sent,u=[];for(p in o)c=o[p],0!==c.state&&1!==c.state||u.push(c.name);e([u]);case 11:case"end":return t.stop()}},t,this)}));return function(e,n){return t.apply(this,arguments)}}(),u.prototype.getRemoteDns=function(t,e){var n=this.name,r=function(t){return new Promise(function(e,r){a.resolve(n,t,function(n,r){void 0!=n?e():e({type:t,records:r})})})};Promise.all([r("A"),r("AAAA"),r("CNAME"),r("MX"),r("NS"),r("SOA"),r("SRV"),r("TXT"),r("NAPTR"),r("PTR")]).then(function(e){var n=!1,r={};for(var a in e)void 0!=e[a]&&0!==e[a].records.length&&(r[e[a].type]=e[a].records,n=!0);this.children.update(),n?t([r]):t()}.bind(this))},u.prototype.getRemotePing=function(t,e){s.promise.probe(this.name,{extra:["-c","40"]}).then(function(e){e.alive||t();var n=Math.floor(1e3*parseFloat(e.avg));t([n])})},u.prototype.getRemoteHttp=function(t,e){var n,r=function(e){this.children.update(),t([n])}.bind(this),a=function(e){n=e.statusCode,this.children.update(),t([n,e.headers.location])}.bind(this),s=i.request({host:this.name,hostname:this.name,path:"/",port:80,method:"HEAD"});setTimeout(function(){s.abort(),t([n])},1e4),s.on("error",r),s.on("abort",r),s.on("timeout",r),s.on("response",a),s.end()},u.prototype.toJson=function(){return{name:this.name,dns:{value:this.dns.value,state:this.dns.state,lastUpdate:this.dns.lastUpdate},ping:{value:this.ping.value,state:this.ping.state,lastUpdate:this.ping.lastUpdate},http:{value:this.http.value,state:this.http.state,lastUpdate:this.http.lastUpdate},children:{value:this.children.value,state:this.children.state,lastUpdate:this.children.lastUpdate}}},u.prototype.toDb=function(t){var e={$name:this.name};return e.$prop="dns"===t||"children"===t?JSON.stringify(this[t].value):this[t].value,e.$propState=this[t].state,e.$propLastUpdate=this[t].lastUpdate,e},u.prototype.setFromDb=function(t){this.dns.value=JSON.parse(t.dns),this.dns.state=t.dnsState,this.dns.lastUpdate=t.dnsLastUpdate,this.ping.value=t.ping,this.ping.state=t.pingState,this.ping.lastUpdate=t.pingLastUpdate,this.http.value=t.http,this.http.state=t.httpState,this.http.lastUpdate=t.httpLastUpdate,this.children.value=t.children,this.children.state=t.childrenState,this.children.lastUpdate=t.childrenLastUpdate},u.prototype.writeState=function(){var t=r(regeneratorRuntime.mark(function t(e){var n;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return n=this.toDb(e),t.next=3,this.db.aRun("UPDATE domains SET "+e+" = $prop, "+e+"State = $propState, "+e+"LastUpdate = $propLastUpdate WHERE name = $name",n);case 3:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}(),u.prototype.delete=r(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.db.aRun("DELETE FROM domains WHERE name = $name",{$name:this.name});case 2:case"end":return t.stop()}},t,this)})),u.prototype.create=r(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.db.aRun("INSERT INTO domains (name) VALUES ($name)",{$name:this.name});case 2:case"end":return t.stop()}},t,this)}))},function(t,e){t.exports=require("http")},function(t,e){t.exports=require("ping")},function(t,e){t.exports=require("abstractdb")},function(t,e){t.exports=require("body-parser")},function(t,e){t.exports=require("compression")}]);