<!DOCTYPE html>
<html>
	<head>
		<title>The Domainatrix</title>
		<style>
			body {
				margin: 0 auto 0 auto;
				padding: 5px 0 5px 0;
				box-sizing: border-box;
				max-width: 700px;
				height: 100vh;
				background-color: #f8f8f8;
				color: #111111;
				font-size: 16px;
				display: flex;
				flex-direction: column;
				font-family: monospace;
				/*line-height: 1.2em;*/
			}
			body > * {
				flex: 0 0 auto;
			}
			.divider {
				width: 100%;
				margin-top: 0.4em;
				border-bottom: 1px solid #111111;
				margin-bottom: 0.4em;
			}
			.centerText {
				width: 100%;
				text-align: center;
			}
			.paddedText {
				margin-top: 0.4em;
			}

			.labeledInput {
				width: 100%;
				display: flex;
				flex-direction: row;
			}
			.labeledInput > *:first-child {
				flex: 0 0 auto;
				margin-right: 1ch;
			}
			.labeledInput > *:nth-child(2) {
				border: 0;
				background-color: transparent;
				border-bottom: 1px solid #999999;
				outline: none;
				flex: 1 1 auto;
				padding: 0;
				font-family: inherit;
				font-size: inherit;
			}
			.labeledInput > *:nth-child(2):focus {
				border-bottom: 1px solid #111111;
			}
			.labeledInput > *:nth-child(3) {
				margin-left: 1ch;
			}
			#searchDomains {
				padding-top: 0.4em;
			}
			#serverFeedback {
				padding-left: 21ch;
			}

			#domainList {
				flex: 1 1 auto;
				overflow-y: scroll;
				padding-right: 2ch;
			}

			.domainListItem {
				text-align: right;
				padding-top: 0.4em;
			}
			.domainPrefix {
				color: #111111;
				font-weight: bolder;
			}
			.domainSuffix {
				color: #999999;
				font-weight: bold;
			}

			.button {
				width: 200px;
				height: 2em;
				cursor: pointer;
				box-sizing: border-box;
				border: 1px solid #999999;
				border-radius: 0.25em;
				align-self: flex-end;
				display: flex;
				flex-direction: row;
				align-items: center;
				justify-content: center;
			}
			.button:hover {
				background-color: #eeeeee;
			}
			.button:active {
				border-color: #111111;
			}

			#credit {
				font-size: 12px;
				width: 100%;
				display: flex;
				flex-direction: row;
				justify-content: space-between;
			}
		</style>

	</head>
	<body>
		<span class="centerText" style="font-size: 20px;">Welcome to the Edinburgh Domainatrix.<!--8th Level of Hell--></span>
		<span class="centerText paddedText"><i>A Place for All Your Edinburgh Domain Needs</i></span>
		<div class="divider"></div>
		<span>- Ever wondered about all those convoluted University of Edinburgh subdomains?<br/>
		- Found a particularly saucy one you'd like to share?<br/>
		- Just looking for an excuse to drink your sorrows away into an inky blackness of expired and illegitimate certificates that plague you like the frogs did Egypt in that one fairy tale?<br/></span>
		<span class="centerText paddedText"><b>You've come to the right place!</b></span>
		<div class="divider"></div>
		<span class="centerText" style="font-size: 18px;">The Domain List (So Far)</span>
		<div id="addDomain" class="paddedText labeledInput"><div id="addDomainPrompt">Submit A New Domain:</div><input id="addDomainInput" type="text" spellcheck="false"></input></div>
		<span class="paddedText" id="serverFeedback"></span>
		<div id="domainList"></div>
		<div id="updateDomainList" class="button paddedText">Update Domain List</div>
		<div id="searchDomains" class="labeledInput"><div id="searchDomainPrompt">Filter Domains (RegExp):</div><input id="searchDomainInput" type="text" spellcheck="false"></input><div id="domainCount"></div></div>
		<div class="divider"></div>
		<div id="credit"><span>Made by <a href="https://www.github.com/dylan-thinnes">Dylan Thinnes</a></span><span>Spot a bug? Let me know on <a href="https://www.github.com/dylan-thinnes/domainatrix/issues">the GitHub repo.</a></span></div>

		<script>
			var DomainListItem = function (domain) {
				this.domain = domain;
				var match = this.domain.match(/([^\s]+\.|)ed\.ac\.uk$/);
				this.hidden = false;
				if (match === null) {
					this.hide();
					this.show = this.hide;
				} else {
					this.subdomain = match[1];
					this.node = document.createElement("div");
					var prefix = document.createElement("span");
					prefix.className = "domainPrefix"
					prefix.appendChild(document.createTextNode(this.subdomain));
					var suffix = document.createElement("span");
					suffix.className = "domainSuffix"
					suffix.appendChild(document.createTextNode("ed.ac.uk"));
					this.node.className = "domainListItem";
					this.node.appendChild(prefix);
					this.node.appendChild(suffix);
				}
			}
			DomainListItem.prototype.hide = function () {
				this.node.style.display = "none";
				this.hidden = true;
			}
			DomainListItem.prototype.show = function () {
				this.node.style.display = "";
				this.hidden = false;
			}
			DomainListItem.prototype.toggle = function () {
				if (this.hidden) this.show();
				else this.hide();
			}
			var DomainList = function (id, searchId, submitId, feedbackId, updateId, domainCountId) {
				/*
				state -2: Getting server domain list.
				state -1: Querying about one domain.
				state 0: The domain is legitimate.
				state 1: The domain is already in the remote list.
				state 2: The domain has no dns lookup.
				state 3: The domain does not meet the regular expression standard.
				state 4: The server returned its domain list.
				state 5: The server did not return a domain list.
				*/
				this.node = document.getElementById(id);
				this.searchNode = document.getElementById(searchId); 
				this.searchNode.addEventListener("input", this.searchDomainItems.bind(this));
				this.entries = {};
				this.inputNode = document.getElementById(submitId);
				this.inputNode.addEventListener("keydown", this.handleInputKeys.bind(this));
				this.domainCount = document.getElementById(domainCountId);
				this.state = 0;
				this.feedback = {
					node: document.getElementById(feedbackId),
					stateTexts: {
						"-2": "Querying server for existing domains...",
						"-1": "Querying server about submitted domain...",
						"0":  "Domain legitimate. Added.",
						"1":  "Domain is already in the list.",
						"2":  "Domain has no DNS entry.",
						"3":  "Domain is not a subdomain of ed.ac.uk.",
						"4":  "Got the domain list from server.",
						"5":  "Could not get the domain list from server."
					},
					stateColours: {
						"-2": "#CDDC39",
						"-1": "#CDDC39",
						"0":  "#4CAf50",
						"1":  "#03A9F4",
						"2":  "#FF5722",
						"3":  "#FF5722",
						"4":  "#4CAf50",
						"5":  "#CDDC39"
					},
					setState: function (state) {
						this.node.innerHTML = this.stateTexts[state];
						this.node.style.backgroundColor = this.stateColours[state];
					}
				}
				this.update = document.getElementById(updateId);
				this.update.addEventListener("click", this.getRemoteDomains.bind(this));
				this.getRemoteDomains();
			}
			Object.defineProperty(DomainList.prototype, "search", {
				"get": function () {
					return this.searchNode.value;
				},
				"set": function (newSearch) {
					this.searchNode.value = newSearch;
				}
			});
			DomainList.prototype.setState = function (state) {
				this.state = state;
				this.feedback.setState(state);
			}
			DomainList.prototype.handleInputKeys = function (e) {
				//console.log(e, this.inputNode.value);
				if (e.keyCode === 13) {
					//console.log("domains being sent");
					e.preventDefault();
					this.askDomain(this.inputNode.value);
				}
			}
			DomainList.prototype.addDomainItem = function (domain) {
				if (this.entries[domain] === undefined) {
					this.entries[domain] = new DomainListItem(domain);
					this.node.appendChild(this.entries[domain].node);
					this.searchDomainItems();
				}
			}
			DomainList.prototype.askDomain = function (domain) {
				if (this.state >= 0) {
					this.feedback.setState(-1);
					var req = new XMLHttpRequest();
					req.open("GET", "/add?domain="+domain);
					req.onreadystatechange = (function (req) {
						if (req.readyState === 4) {
							this.serverResponseControl(req.response);
						}
					}).bind(this, req);
					req.send();
				} else {
					console.log("State already running, wait until later.");
				}
			}
			DomainList.prototype.getRemoteDomains = function () {
				if (this.state >= 0) {
					this.setState(-2);
					var req = new XMLHttpRequest();
					req.open("GET", "/data");
					req.onreadystatechange = (function (req) {
						if (req.readyState === 4) {
							//console.log(req.response);
							this.setRemoteDomains(req.response);
						}
					}).bind(this, req);
					req.send();
				} else {
					console.log("State already running, wait until later.");
				}

			}
			DomainList.prototype.setRemoteDomains = function (res) {
				try {
					var resJson = JSON.parse(res);
					for (var ii = 0; ii  < resJson.length; ii++) {
						this.addDomainItem(resJson[ii]);
					}
					this.setState(4);
					this.searchDomainItems();
				} catch (e) {
					this.setState(5);
					console.log(e, "Illegitimate output from server on /data endpoint.");
				}
			}
			DomainList.prototype.serverResponseControl = function (res) {
				try {
					var resJson = JSON.parse(res);
					this.setState(resJson.state);
					if (resJson.state === 0) {
						//console.log("Domain was accepted.");
						this.addDomainItem(resJson.domain);
					} else {
						//console.log("Domain was not accepted.");
					}
				} catch (e) {
					//console.log(e, "Illegitimate output from server on /add endpoint.");
				}
			}
			DomainList.prototype.searchDomainItems = function (e) {
				//console.log(e, this.search, new RegExp(this.search));
				if (this.search === "") {
					var entriesExist = 0;
					var entriesShown = 0;
					for (var domain in this.entries) {
						this.entries[domain].show();
						entriesExist++;
						entriesShown++;
					}
					this.domainCount.innerHTML = entriesShown.toString() + "/" + entriesExist.toString();
				} else {
					try {
						var regex = new RegExp(this.search);
					} catch (e) {
						return;
					}
					var entriesExist = 0;
					var entriesShown = 0;
					for (var domain in this.entries) {
						//console.log(domain);
						if (this.entries[domain].domain.match(regex) !== null) {
							this.entries[domain].show();
							entriesShown++;
						} else this.entries[domain].hide();
						entriesExist++;
					}
					this.domainCount.innerHTML = entriesShown.toString() + "/" + entriesExist.toString();
				}
			}
			var list = new DomainList("domainList", "searchDomainInput", "addDomainInput", "serverFeedback", "updateDomainList", "domainCount");
		</script>
	</body>
</html>
