<!DOCTYPE html>
<html>
	<head>
		<title>The Domainatrix</title>
		<style>
			body {
				margin: 0 auto 0 auto;
				padding: 5px 0 5px 0;
				box-sizing: border-box;
				max-width: 700px;
				height: 100vh;
				background-color: #f8f8f8;
				color: #111111;
				font-size: 16px;
				display: flex;
				flex-direction: column;
				font-family: monospace;
				/*line-height: 1.2em;*/
			}
			body > * {
				flex: 0 0 auto;
			}
			.divider {
				width: 100%;
				margin-top: 0.4em;
				border-bottom: 1px solid #111111;
				margin-bottom: 0.4em;
			}
			.centerText {
				width: 100%;
				text-align: center;
			}
			.paddedText {
				margin-top: 0.4em;
			}

			.labeledInput {
				width: 100%;
				display: flex;
				flex-direction: row;
			}
			.labeledInput > div:first-child {
				flex: 0 0 auto;
				margin-right: 1ch;
			}
			.labeledInput > div:last-child {
				border-bottom: 1px solid #999999;
				outline: none;
				flex: 1 1 auto;
			}
			.labeledInput > div:last-child:focus {
				border-bottom: 1px solid #111111;
			}
			#searchDomains {
				padding-top: 0.4em;
			}
			#serverFeedback {
				padding-left: 21ch;
			}

			#domainList {
				flex: 1 1 auto;
				overflow-y: scroll;
				padding-right: 2ch;
			}

			.domainListItem {
				text-align: right;
				padding-top: 0.4em;
			}
			.domainPrefix {
				color: maroon;
				font-weight: bolder;
			}
			.domainSuffix {
				color: #111111;
				font-weight: bold;
			}
		</style>

	</head>
	<body>
		<span class="centerText" style="font-size: 20px;">Welcome to the Edinburgh Domainatrix.<!--8th Level of Hell--></span>
		<span class="centerText paddedText"><i>A Place for All Your Edinburgh Domain Needs</i><br/>
		<div class="divider"></div>
		- Ever wondered about all those convoluted University of Edinburgh subdomains?<br/>
		- Found a particularly saucy one you'd like to share?<br/>
		- Just looking for an excuse to drink your sorrows away into an inky blackness of expired and illegitimate certificates that plague you like the frogs did Egypt in that one fairy tale?<br/></span>
		<span class="centerText paddedText"><b>You've come to the right place!</b></span>
		<div class="divider"></div>
		<span class="centerText" style="font-size: 18px;">The Domain List (So Far)</span>
		<div id="addDomain" class="paddedText labeledInput"><div id="addDomainPrompt">Submit A New Domain:</div><div id="addDomainInput" contenteditable spellcheck="false"></div></div>
		<span class="paddedText" id="serverFeedback"></span>
		<div id="domainList"></div>
		<div id="searchDomains" class="labeledInput"><div id="searchDomainPrompt">Filter Domains (RegExp):</div><div id="searchDomainInput" contenteditable spellcheck="false"></div></div>

		<script>
			var DomainListItem = function (domain) {
				this.domain = domain;
				var match = this.domain.match(/([^\s]+\.|)ed\.ac\.uk$/);
				this.hidden = false;
				if (match === null) {
					this.hide();
					this.show = this.hide;
				} else {
					this.subdomain = match[1];
					this.node = document.createElement("div");
					var prefix = document.createElement("span");
					prefix.className = "domainPrefix"
					prefix.appendChild(document.createTextNode(this.subdomain));
					var suffix = document.createElement("span");
					suffix.className = "domainSuffix"
					suffix.appendChild(document.createTextNode("ed.ac.uk"));
					this.node.className = "domainListItem";
					this.node.appendChild(prefix);
					this.node.appendChild(suffix);
				}
			}
			DomainListItem.prototype.hide = function () {
				this.node.style.display = "none";
				this.hidden = true;
			}
			DomainListItem.prototype.show = function () {
				this.node.style.display = "";
				this.hidden = false;
			}
			DomainListItem.prototype.toggle = function () {
				if (this.hidden) this.show();
				else this.hide();
			}
			var DomainList = function (id, searchId, submitId, feedbackId) {
				this.node = document.getElementById(id);
				this.searchNode = document.getElementById(searchId); 
				this.searchNode.addEventListener("input", this.searchDomainItems.bind(this));
				this.entries = {};
				this.inputNode = document.getElementById(submitId);
				this.inputNode.addEventListener("keydown", this.handleInputKeys.bind(this));
				this.feedback = {
					div: document.getElementById(feedbackId),
					setState: function (state) {
						//console.log(state);
						/*
						state 0: The domain is legitimate.
						state 1: The domain is already in the remote list.
						state 2: The domain has no dns lookup.
						state 3: The domain does not meet the regular expression standard.
						*/
						if (state === 0) this.div.innerHTML = "Domain legitimate. Added.";
						else if (state === 1) this.div.innerHTML = "Domain is already in the list.";
						else if (state === 2) this.div.innerHTML = "Domain's DNS lookup can't be resolved.";
						else if (state === 3) this.div.innerHTML = "Domain is not a subdomain of ed.ac.uk.";
					}
				}
				this.getRemoteDomains();
			}
			Object.defineProperty(DomainList.prototype, "search", {
				"get": function () {
					return this.searchNode.innerHTML;
				},
				"set": function (newSearch) {
					this.searchNode.innerHTML = newSearch;
				}
			});
			DomainList.prototype.handleInputKeys = function (e) {
				if (e.keyCode === 13) {
					//console.log("domains being sent");
					event.preventDefault();
					this.askDomain(this.inputNode.innerHTML);
				}
			}
			DomainList.prototype.addDomainItem = function (domain) {
				if (this.entries[domain] === undefined) {
					this.entries[domain] = new DomainListItem(domain);
					this.node.appendChild(this.entries[domain].node);
				}
			}
			DomainList.prototype.askDomain = function (domain) {
				var req = new XMLHttpRequest();
				req.open("GET", "/add?domain="+domain);
				req.onreadystatechange = (function (req) {
					if (req.readyState === 4) {
						this.serverResponseControl(req.response);
					}
				}).bind(this, req);
				req.send();
			}
			DomainList.prototype.getRemoteDomains = function () {
				var req = new XMLHttpRequest();
				req.open("GET", "/data");
				req.onreadystatechange = (function (req) {
					if (req.readyState === 4) {
						//console.log(req.response);
						this.setRemoteDomains(req.response);
					}
				}).bind(this, req);
				req.send();
			}
			DomainList.prototype.setRemoteDomains = function (res) {
				try {
					var resJson = JSON.parse(res);
					for (var ii = 0; ii  < resJson.length; ii++) {
						this.addDomainItem(resJson[ii]);
					}
				} catch (e) {
					console.log(e, "Illegitimate output from server on /data endpoint.");
				}
			}
			DomainList.prototype.serverResponseControl = function (res) {
				try {
					var resJson = JSON.parse(res);
					this.feedback.setState(resJson.state);
					if (resJson.state === 0) {
						//console.log("Domain was accepted.");
						this.addDomainItem(resJson.domain);
					} else {
						//console.log("Domain was not accepted.");
					}
				} catch (e) {
					//console.log(e, "Illegitimate output from server on /add endpoint.");
				}
			}
			DomainList.prototype.searchDomainItems = function (e) {
				//console.log(e, this.search, new RegExp(this.search));
				if (this.search === "") {
					for (var domain in this.entries) {
						this.entries[domain].show();
					}
				} else {
					for (var domain in this.entries) {
						//console.log(domain);
						if (this.entries[domain].domain.match(new RegExp(this.search)) !== null) this.entries[domain].show();
						else this.entries[domain].hide();
					}
				}
			}
			var list = new DomainList("domainList", "searchDomainInput", "addDomainInput", "serverFeedback");
		</script>
	</body>
</html>
